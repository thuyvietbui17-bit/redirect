<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Loading</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body,html{width:100%;height:100%;overflow:hidden}
body{background:#667eea;display:flex;align-items:center;justify-content:center;font-family:Arial}
.load{color:#fff;text-align:center}
.spin{width:30px;height:30px;border:2px solid rgba(255,255,255,0.3);border-top:2px solid #fff;border-radius:50%;animation:s 1s linear infinite;margin:0 auto 15px}
@keyframes s{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
iframe{position:fixed;top:0;left:0;width:100%;height:100%;border:none;display:none;pointer-events:auto}
.err{display:none}
@media(max-width:768px){.spin{width:25px;height:25px}.load{font-size:14px;padding:0 20px}}
</style>
</head>
<body>
<div class="load" id="l">
<div class="spin"></div>
<div>Loading...</div>
</div>
<div class="err" id="e">Access Denied</div>
<iframe id="f" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
<script>
const u=new URLSearchParams(location.search);
const a=u.get('a'),b=u.get('b'),c=parseInt(u.get('c')||5);
if(!a||!b){document.getElementById('e').style.display='block';document.getElementById('l').style.display='none'}
else{
const n=Date.now(),t=parseInt(b,36),x=t+c*6e4;
if(n>x){document.getElementById('e').style.display='block';document.getElementById('l').style.display='none'}
else{
setTimeout(()=>{
try{
const r=atob(a),i=document.getElementById('f');
i.src=r;
i.onload=()=>{document.getElementById('l').style.display='none';i.style.display='block';protectFrame()};
setTimeout(()=>{if(i.style.display==='none'){document.getElementById('l').style.display='none';i.style.display='block';protectFrame()}},8000)
}catch(e){document.getElementById('e').style.display='block';document.getElementById('l').style.display='none'}
},1500)}}

function protectFrame(){
try{
const frame = document.getElementById('f');
const doc = frame.contentDocument;
const win = frame.contentWindow;

if(doc){
// 移除所有target属性
const allLinks = doc.querySelectorAll('a');
allLinks.forEach(link => {
link.removeAttribute('target');
link.addEventListener('click', function(e) {
e.preventDefault();
e.stopPropagation();
if(this.href && !this.href.startsWith('javascript:') && !this.href.startsWith('mailto:') && !this.href.startsWith('tel:')){
frame.src = this.href;
}
}, true);
});

// 监听动态添加的链接
const observer = new MutationObserver(function(mutations) {
mutations.forEach(function(mutation) {
mutation.addedNodes.forEach(function(node) {
if(node.nodeType === 1) {
if(node.tagName === 'A') {
node.removeAttribute('target');
node.addEventListener('click', function(e) {
e.preventDefault();
e.stopPropagation();
if(this.href && !this.href.startsWith('javascript:') && !this.href.startsWith('mailto:') && !this.href.startsWith('tel:')){
frame.src = this.href;
}
}, true);
}
const links = node.querySelectorAll ? node.querySelectorAll('a') : [];
links.forEach(link => {
link.removeAttribute('target');
link.addEventListener('click', function(e) {
e.preventDefault();
e.stopPropagation();
if(this.href && !this.href.startsWith('javascript:') && !this.href.startsWith('mailto:') && !this.href.startsWith('tel:')){
frame.src = this.href;
}
}, true);
});
}
});
});
});
observer.observe(doc, {childList: true, subtree: true});

// 处理表单
const forms = doc.querySelectorAll('form');
forms.forEach(form => {
form.removeAttribute('target');
form.addEventListener('submit', function(e) {
e.preventDefault();
const formData = new FormData(this);
const action = this.action || frame.src;
const method = this.method.toLowerCase();
if(method === 'post'){
const params = new URLSearchParams();
for(let [key, value] of formData.entries()){
params.append(key, value);
}
fetch(action, {
method: 'POST',
body: params,
headers: {'Content-Type': 'application/x-www-form-urlencoded'}
}).then(response => response.text())
.then(html => {
const blob = new Blob([html], {type: 'text/html'});
frame.src = URL.createObjectURL(blob);
}).catch(() => {
frame.src = action + '?' + params.toString();
});
} else {
const params = new URLSearchParams(formData);
frame.src = action + '?' + params.toString();
}
}, true);
});
}

if(win){
// 完全禁用window.open
win.open = function() { return null; };

// 禁用location操作
try {
Object.defineProperty(win, 'location', {
get: function() {
return {
href: frame.src,
replace: function() {},
assign: function() {},
reload: function() { frame.src = frame.src; }
};
},
set: function() {}
});
} catch(e) {}

// 禁用top和parent访问
try {
Object.defineProperty(win, 'top', {
get: function() { return win; }
});
Object.defineProperty(win, 'parent', {
get: function() { return win; }
});
} catch(e) {}
}

// 每秒重新应用保护
setTimeout(protectFrame, 1000);

}catch(e){
setTimeout(protectFrame, 2000);
}
}

// 阻止页面级别的导航
window.addEventListener('beforeunload', function(e) {
e.preventDefault();
e.returnValue = '';
return '';
});

document.addEventListener('click', function(e) {
const link = e.target.closest('a');
if(link && link.href && !link.href.startsWith(window.location.origin)){
e.preventDefault();
e.stopPropagation();
return false;
}
}, true);
</script>
</body>
</html>
